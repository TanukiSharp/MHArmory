<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:local="clr-namespace:MHArmory"
                    xmlns:localcvt="clr-namespace:MHArmory.ValueConverters"
                    xmlns:cvt="clr-namespace:MHArmory.Core.WPF.ValueConverters;assembly=MHArmory.Core.WPF"
                    xmlns:bhv="clr-namespace:MHArmory.Core.WPF.Behaviors;assembly=MHArmory.Core.WPF"
                    xmlns:ctrl="clr-namespace:MHArmory.Core.WPF.Controls;assembly=MHArmory.Core.WPF"
                    xmlns:mxt="clr-namespace:MHArmory.Core.WPF.MarkupExtensions;assembly=MHArmory.Core.WPF"
                    xmlns:pnl="clr-namespace:MHArmory.Core.WPF.Panels;assembly=MHArmory.Core.WPF">

    <localcvt:AbilityToViewModelValueConverter x:Key="AbilityToViewModelValueConverter"/>
    <localcvt:SortCriteriaNameValueConverter x:Key="SortCriteriaNameValueConverter"/>

    <cvt:HiddenVisibilityValueConverter x:Key="HiddenVisibilityValueConverter"/>
    <cvt:CollapsedVisibilityValueConverter x:Key="CollapsedVisibilityValueConverter"/>
    <cvt:InverseBooleanValueConverter x:Key="InverseBooleanValueConverter"/>
    <cvt:EquipmentEnumToImageSourceValueConverter x:Key="EquipmentEnumToImageSourceValueConverter"/>
    <cvt:WeaponEnumToImageSourceValueConverter x:Key="WeaponEnumToImageSourceValueConverter"/>
    <cvt:ElementEnumToImageSourceValueConverter x:Key="ElementEnumToImageSourceValueConverter"/>
    <cvt:SlotToImageSourceValueConverter x:Key="SlotToImageSourceValueConverter"/>
    <cvt:SlotSizeToolTipValueConverter x:Key="SlotSizeToolTipValueConverter"/>
    <cvt:HasDefenseVisibilityValueConverter x:Key="HasDefenseVisibilityValueConverter"/>
    <cvt:WeaponNameValueConverter x:Key="WeaponNameValueConverter"/>
    <cvt:SharpnessNameValueConverter x:Key="SharpnessNameValueConverter"/>
    <cvt:ElementNameValueConverter x:Key="ElementNameValueConverter"/>
    <cvt:MillisecondsToTimeValueConverter x:Key="MillisecondsToTimeValueConverter"/>
    <cvt:NumToSeparatedStringValueConverter x:Key="NumToSeparatedStringValueConverter"/>
    <cvt:FreeElementNameValueConverter x:Key="FreeElementNameValueConverter"/>
    <cvt:CombinationPerSecondValueConverter x:Key="CombinationPerSecondValueConverter"/>
    <cvt:ScrollBarVisibilityValueConverter x:Key="ScrollBarVisibilityValueConverter"/>

    <SolidColorBrush x:Key="ActiveWeaponBackgroundBrush" Color="#FFB7FFA7"/>
    <SolidColorBrush x:Key="ActiveWeaponBorderBrush" Color="#FF55D15A"/>
    <SolidColorBrush x:Key="InactiveToggleBackgroundBrush" Color="#FFFFB7B7"/>

    <DataTemplate x:Key="ExtensionView">
        <RadioButton Margin="2" Padding="2" IsChecked="{Binding IsActive}" IsThreeState="False" VerticalContentAlignment="Center">
            <Border x:Name="x" CornerRadius="3" Padding="2" Background="WhiteSmoke">
                <StackPanel Orientation="Horizontal">
                    <StackPanel Orientation="Horizontal" DataContext="{Binding Extension, Mode=OneTime}">
                        <StackPanel Margin="1 1 6 1">
                            <TextBlock Text="{Binding Name, Mode=OneTime}" FontWeight="Bold" Margin="2"/>
                            <TextBlock Text="{Binding Description, Mode=OneTime}" Margin="2" MaxWidth="250" TextTrimming="CharacterEllipsis" ToolTip="{Binding Description, Mode=OneTime}"/>
                        </StackPanel>
                        <StackPanel Margin="1">
                            <TextBlock Text="{Binding Version, StringFormat='Version {0}', Mode=OneTime}" Margin="2" Foreground="Gray" FontSize="10"/>
                            <TextBlock Text="{Binding Author, Mode=OneTime}" Margin="2" Foreground="Gray" FontSize="10" MaxWidth="120" TextTrimming="CharacterEllipsis" ToolTip="{Binding Author, Mode=OneTime}"/>
                        </StackPanel>
                    </StackPanel>
                    <Button Content="Configure..." VerticalAlignment="Center" Margin="4" Padding="4" Visibility="{Binding IsConfigurable, Mode=OneTime, Converter={StaticResource CollapsedVisibilityValueConverter}}" Command="{Binding ConfigureCommand, Mode=OneTime}"/>
                </StackPanel>
            </Border>
        </RadioButton>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsActive}" Value="True">
                <Setter TargetName="x" Property="Background" Value="#A0C0E0"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="ExtensionCategoryView">
        <Expander Margin="8" Padding="4" Background="#E0E0E0" IsExpanded="True">
            <Expander.Header>
                <TextBlock Text="{Binding Name, Mode=OneTime}" FontWeight="Bold"/>
            </Expander.Header>
            <ItemsControl ItemsSource="{Binding Extensions, Mode=OneTime}" Margin="16 0 0 0" ItemTemplate="{StaticResource ExtensionView}" Focusable="False"/>
        </Expander>
    </DataTemplate>

    <DataTemplate x:Key="ExtensionSelectorView">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Visible">
            <ItemsControl ItemsSource="{Binding Categories, Mode=OneTime}" ItemTemplate="{StaticResource ExtensionCategoryView}" Focusable="False"/>
        </ScrollViewer>
    </DataTemplate>

    <DataTemplate x:Key="SaveDataSlotView">
        <StackPanel Orientation="Horizontal">
            <TextBlock Margin="1 1 6 1" Text="{Binding SlotNumber, Mode=OneTime, StringFormat=\{0\}.}" VerticalAlignment="Center"/>
            <Button x:Name="root" Command="{Binding SelectionCommand, Mode=OneTime}" Background="WhiteSmoke" BorderBrush="LightGray" BorderThickness="1">
                <Button.Template>
                    <ControlTemplate>
                        <Border BorderBrush="{TemplateBinding BorderBrush}" Background="{TemplateBinding Background}" CornerRadius="3" Margin="4" BorderThickness="{TemplateBinding BorderThickness}" Padding="8" VerticalAlignment="Center" TextBlock.FontSize="14" Focusable="False">
                            <Grid Focusable="False">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="A"/>
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="B"/>
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="C"/>
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="D"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Margin="1 1 8 1" Grid.Column="0">
                                    <Run Text="Name: "/>
                                    <Run Text="{Binding Name, Mode=OneTime}" FontWeight="Bold" Foreground="Blue"/>
                                </TextBlock>
                                <TextBlock Margin="1 1 8 1" Grid.Column="1">
                                    <Run Text="Rank: "/>
                                    <Run Text="{Binding Rank, Mode=OneTime}" FontWeight="Bold" Foreground="Blue"/>
                                </TextBlock>
                                <TextBlock Margin="1 1 8 1" Grid.Column="2">
                                    <Run Text="Playtime: "/>
                                    <Run Text="{Binding Playtime, Mode=OneTime}" FontWeight="Bold" Foreground="Blue"/>
                                </TextBlock>
                                <TextBlock Margin="1 1 8 1" Grid.Column="3">
                                    <Run Text="Zeni: "/>
                                    <Run Text="{Binding Zeni, Mode=OneTime}" FontWeight="Bold" Foreground="Blue"/>
                                </TextBlock>
                            </Grid>
                        </Border>
                    </ControlTemplate>
                </Button.Template>
            </Button>
        </StackPanel>
        <DataTemplate.Triggers>
            <Trigger SourceName="root" Property="IsMouseOver" Value="True">
                <Setter TargetName="root" Property="Background" Value="#E0F4FF"/>
            </Trigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="SaveDataAccountView">
        <Border BorderBrush="LightGray" Background="White" CornerRadius="3" Margin="2 2 2 8" BorderThickness="2" Padding="2" Focusable="False">
            <StackPanel Orientation="Vertical" Focusable="False">
                <TextBlock Foreground="Gray" Margin="1">
                    <Run Text="User: "/>
                    <Run Text="{Binding UserId, Mode=OneTime}"/>
                </TextBlock>
                <ItemsControl ItemsSource="{Binding SaveDataSlots, Mode=OneTime}" ItemTemplate="{StaticResource SaveDataSlotView}" Grid.IsSharedSizeScope="True" Margin="16 0 0 0" Focusable="False"/>
            </StackPanel>
        </Border>
    </DataTemplate>

    <DataTemplate x:Key="SaveDataSlotSelectorView">
        <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Visible" Padding="6">
            <ItemsControl ItemsSource="{Binding Accounts}" ItemTemplate="{StaticResource SaveDataAccountView}" Focusable="False"/>
        </ScrollViewer>
    </DataTemplate>

    <DataTemplate x:Key="FullSkillDescriptionView">
        <StackPanel>
            <TextBlock Text="{mxt:Localization GeneralDescription}" Margin="2" MaxWidth="370" TextWrapping="Wrap" HorizontalAlignment="Left" FontWeight="Black"/>
            <ItemsControl ItemsSource="{Binding Abilities, Mode=OneTime}" Margin="12 2 2 2">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock x:Name="item" Text="{Binding Description, Mode=OneWay}" Margin="2"/>
                        <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsActive, Mode=OneTime}" Value="True">
                                <Setter TargetName="item" Property="FontWeight" Value="Bold"/>
                                <Setter TargetName="item" Property="Foreground" Value="Blue"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsOver, Mode=OneTime}" Value="True">
                                <Setter TargetName="item" Property="Foreground" Value="DarkOrange"/>
                            </DataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>
    </DataTemplate>

    <DataTemplate x:Key="WeaponSlotView">
        <ComboBox SelectedIndex="{Binding Value}" Margin="0" Padding="5" VerticalContentAlignment="Center">
            <TextBlock Text="-" Style="{StaticResource ComboBoxItemSlotStyle}"/>
            <Image Source="{mxt:RasterizedImage Location=Icons/Jewels/Jewel1.svg, Size=16}" Style="{StaticResource ComboBoxItemSlotStyle}"/>
            <Image Source="{mxt:RasterizedImage Location=Icons/Jewels/Jewel2.svg, Size=16}" Style="{StaticResource ComboBoxItemSlotStyle}"/>
            <Image Source="{mxt:RasterizedImage Location=Icons/Jewels/Jewel3.svg, Size=16}" Style="{StaticResource ComboBoxItemSlotStyle}"/>
        </ComboBox>
    </DataTemplate>

    <DataTemplate x:Key="InParametersView">

        <StackPanel Orientation="Horizontal" VerticalAlignment="Stretch">

            <StackPanel VerticalAlignment="Stretch">
                <TextBlock Text="Weapon slots:" VerticalAlignment="Center" Margin="2"/>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Stretch">
                    <ContentControl Content="{Binding Slots[0], Mode=OneTime}" ContentTemplate="{StaticResource WeaponSlotView}" Margin="1 2 1 2" Focusable="False"/>
                    <ContentControl Content="{Binding Slots[1], Mode=OneTime}" ContentTemplate="{StaticResource WeaponSlotView}" Margin="1 2 1 2" Focusable="False"/>
                    <ContentControl Content="{Binding Slots[2], Mode=OneTime}" ContentTemplate="{StaticResource WeaponSlotView}" Margin="1 2 1 2" Focusable="False"/>
                    <Button x:Name="weaponsButton" MinWidth="40" MaxWidth="40" Margin="1 2 1 2" Command="{x:Static local:RoutedCommands.OpenWeapons}" bhv:ToolTipEx.Content="See weapons matching the currently selected slots" ToolTipService.ShowOnDisabled="True">
                        <Image Source="{mxt:RasterizedImage Location=Icons/Weapons/GreatSword.svg, Size=20}" Height="20" Width="20"/>
                    </Button>
                </StackPanel>
            </StackPanel>

            <Rectangle Style="{StaticResource sep}"/>

            <StackPanel VerticalAlignment="Stretch">
                <TextBlock Text="Decorations override:" Margin="2"/>
                <StackPanel Orientation="Horizontal">
                    <CheckBox Content="Activate" IsChecked="{Binding UseDecorationsOverride}" Margin="2" VerticalAlignment="Center" VerticalContentAlignment="Center"/>
                    <Button Content="Setup..." Command="{Binding OpenDecorationsOverrideCommand, Mode=OneTime}" Margin="2" Padding="4" MinWidth="70" VerticalAlignment="Center"/>
                    <Button Content="?" MinWidth="20" Margin="2" Padding="4" VerticalAlignment="Center" Command="{x:Static local:RoutedCommands.OpenIntegratedHelp}" CommandParameter="DecorationsOverride" bhv:ToolTipEx.Content="Show help about decorations override"/>
                </StackPanel>
            </StackPanel>

            <Rectangle Style="{StaticResource sep}"/>

            <StackPanel VerticalAlignment="Stretch">
                <TextBlock Text="Equipment override:" Margin="2"/>
                <StackPanel Orientation="Horizontal">
                    <CheckBox Content="Activate" IsChecked="{Binding UseEquipmentOverride}" Margin="2" VerticalAlignment="Center" VerticalContentAlignment="Center"/>
                    <Button Content="Setup..." Command="{Binding OpenEquipmentOverrideCommand, Mode=OneTime}" Margin="2" Padding="4" MinWidth="70" VerticalAlignment="Center"/>
                    <Button Content="?" MinWidth="20" Margin="2" Padding="4" VerticalAlignment="Center" Command="{x:Static local:RoutedCommands.OpenIntegratedHelp}" CommandParameter="EquipmentOverride" bhv:ToolTipEx.Content="Show help about equipment override"/>
                </StackPanel>
            </StackPanel>

            <Rectangle Style="{StaticResource sep}"/>

            <StackPanel VerticalAlignment="Stretch">
                <TextBlock Text="Rarity:" Margin="2"/>
                <ComboBox VerticalAlignment="Stretch" Margin="2" MinWidth="50" SelectedIndex="{Binding RarityIndex}">
                    <ComboBox.Resources>
                        <Style TargetType="TextBlock">
                            <Setter Property="Padding" Value="1 2 1 2"/>
                        </Style>
                    </ComboBox.Resources>
                    <TextBlock>1</TextBlock>
                    <TextBlock>2</TextBlock>
                    <TextBlock>3</TextBlock>
                    <TextBlock>4</TextBlock>
                    <TextBlock>5</TextBlock>
                    <TextBlock>6</TextBlock>
                    <TextBlock>7</TextBlock>
                    <TextBlock>8</TextBlock>
                    <TextBlock>9</TextBlock>
                </ComboBox>
            </StackPanel>

            <Rectangle Style="{StaticResource sep}"/>

            <StackPanel VerticalAlignment="Stretch">
                <TextBlock Text="Gender:" Margin="2"/>
                <ComboBox VerticalAlignment="Stretch" Margin="2" MinWidth="70" SelectedIndex="{Binding GenderIndex}">
                    <ComboBox.Resources>
                        <Style TargetType="TextBlock">
                            <Setter Property="Padding" Value="1 2 1 2"/>
                        </Style>
                    </ComboBox.Resources>
                    <TextBlock>Male</TextBlock>
                    <TextBlock>Female</TextBlock>
                    <TextBlock>Both</TextBlock>
                </ComboBox>
            </StackPanel>

        </StackPanel>

        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding WeaponsContainer.IsFeatureEnabled}" Value="False">
                <Setter TargetName="weaponsButton" Property="IsEnabled" Value="False"/>
                <Setter TargetName="weaponsButton" Property="bhv:ToolTipEx.Content" Value="{Binding WeaponsContainer.FeatureDisabledReason}"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <!-- In skill selector window -->
    <DataTemplate x:Key="AbilityView">
        <StackPanel Orientation="Horizontal">
            <TextBlock x:Name="lvl" Focusable="False">
                <Run Text="Level"/>
                <Run Text="{Binding Level, Mode=OneTime}"/>
                <Run Text="  "/>
            </TextBlock>
            <TextBlock Text="{mxt:Localization AbilityDescription}" Foreground="DarkGray"/>
        </StackPanel>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding Level, Mode=OneWay}" Value="0">
                <Setter TargetName="lvl" Property="Visibility" Value="Hidden"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <!-- On armor pieces in search result view on the main window -->
    <DataTemplate x:Key="StandaloneAbilityView">
        <TextBlock Focusable="False">
            <bhv:ToolTipEx.Content>
                <ContentControl Content="{Binding Description, Mode=OneTime}" ContentTemplate="{StaticResource FullSkillDescriptionView}"/>
            </bhv:ToolTipEx.Content>
            <Run Text="{mxt:Localization SkillName}" FontWeight="Bold"/>
            <Run Text="level"/>
            <Run Text="{Binding Level, Mode=OneTime}"/>
        </TextBlock>
    </DataTemplate>

    <!-- Selected skills in the main window -->
    <DataTemplate x:Key="SelectedAbilityView">
        <StackPanel x:Name="root" Orientation="Horizontal" Margin="0 1 0 1" TextBlock.FontSize="14" Focusable="False">
            <bhv:ToolTipEx.Content>
                <ContentControl Content="{Binding Description, Mode=OneTime}" ContentTemplate="{StaticResource FullSkillDescriptionView}"/>
            </bhv:ToolTipEx.Content>
            <TextBlock Text="{mxt:Localization SkillName}" FontWeight="Bold"/>
            <TextBlock x:Name="lvl1" Text=" level "/>
            <TextBlock x:Name="lvl2" Text="{Binding Level, Mode=OneTime}"/>
            <TextBlock x:Name="lvl3" Text=" excluded" Visibility="Collapsed"/>
        </StackPanel>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsChecked, Mode=OneWay}" Value="False">
                <Setter TargetName="root" Property="Visibility" Value="Collapsed"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding Level, Mode=OneWay}" Value="0">
                <Setter TargetName="root" Property="TextBlock.Foreground" Value="LightSteelBlue"/>
                <Setter TargetName="lvl1" Property="Visibility" Value="Collapsed"/>
                <Setter TargetName="lvl2" Property="Visibility" Value="Collapsed"/>
                <Setter TargetName="lvl3" Property="Visibility" Value="Visible"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="ArmorSetSkillPartView">
        <StackPanel Orientation="Horizontal">
            <Border CornerRadius="2" BorderThickness="2" BorderBrush="#20000000" Background="#10000000" VerticalAlignment="Top" Width="{Binding ActualHeight, RelativeSource={RelativeSource Mode=Self}}" Margin="2">
                <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" Text="{Binding RequiredArmorPieces, Mode=OneTime}" FontWeight="Bold"/>
            </Border>
            <ItemsControl ItemsSource="{Binding GrantedSkills, Mode=OneTime}" Margin="2" Focusable="False">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{mxt:Localization Skill.Name}"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>
    </DataTemplate>

    <DataTemplate x:Key="ArmorSetSkillView">
        <StackPanel Orientation="Horizontal">
            <TextBlock Text="{mxt:Localization Name}" VerticalAlignment="Top" Margin="6 0 6 0"/>
            <ItemsControl ItemsSource="{Binding Parts, Mode=OneTime}" ItemTemplate="{StaticResource ArmorSetSkillPartView}" Focusable="False"/>
        </StackPanel>
    </DataTemplate>

    <DataTemplate x:Key="CraftMaterialView">
        <TextBlock>
            <Run Text="{mxt:Localization LocalizedItem.Values}"/>
            <Run Text="{Binding Quantity, Mode=OneTime, StringFormat='x{0}'}"/>
        </TextBlock>
    </DataTemplate>

    <DataTemplate x:Key="ArmorPieceView">
        <Border CornerRadius="2" BorderThickness="1" BorderBrush="#30000000" Background="#10000000" Margin="2" Padding="4" HorizontalAlignment="Stretch">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="A"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="B"/>
                    <ColumnDefinition Width="Auto" SharedSizeGroup="C"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <StackPanel Orientation="Vertical">
                    <StackPanel Grid.Column="0" Orientation="Vertical" Margin="0 0 8 0">
                        <StackPanel Orientation="Horizontal" Grid.IsSharedSizeScope="True">
                            <Image Source="{Binding Type, Mode=OneTime, Converter={StaticResource EquipmentEnumToImageSourceValueConverter}, ConverterParameter=20}" Width="20" Height="20" Margin="0 0 4 0" VerticalAlignment="Center" Focusable="False"/>
                            <TextBlock Text="{mxt:Localization Name}" FontSize="12" FontWeight="Bold" VerticalAlignment="Center" Focusable="False"/>
                        </StackPanel>
                        <TextBlock Margin="2" Foreground="Gray" Visibility="{Binding Mode=OneTime, Converter={StaticResource HasDefenseVisibilityValueConverter}}" Focusable="False">
                            <Run Text="Def: "/>
                            <Run Text="{Binding Defense.Base, Mode=OneTime}"/>
                            <Run Text=" / "/>
                            <Run Text="{Binding Defense.Max, Mode=OneTime}"/>
                            <Run Text=" / "/>
                            <Run Text="{Binding Defense.Augmented, Mode=OneTime}"/>
                        </TextBlock>
                    </StackPanel>
                    <Image x:Name="possessedIcon" Source="{mxt:RasterizedImage Location=Icons/Others/cube_chest.svg, Size=16}" Visibility="Hidden" Width="16" Height="16" Margin="1" HorizontalAlignment="Left" IsHitTestVisible="False" SnapsToDevicePixels="True"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Margin="0 0 8 0" Orientation="Vertical">
                    <TextBlock VerticalAlignment="Top" HorizontalAlignment="Left" Focusable="False">
                        <Run Text="Rarity"/>
                        <Run Text="{Binding Rarity, Mode=OneTime}"/>
                    </TextBlock>
                    <ItemsControl ItemsSource="{Binding Slots, Mode=OneTime}" Margin="2" Height="24" Focusable="False">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Image Source="{Binding Converter={StaticResource SlotToImageSourceValueConverter}, ConverterParameter=24, Mode=OneTime}" bhv:ToolTipEx.Content="{Binding Converter={StaticResource SlotSizeToolTipValueConverter}, Mode=OneTime}" Width="24" Height="24" SnapsToDevicePixels="True"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </StackPanel>
                <ItemsControl Grid.Column="2" ItemsSource="{Binding Abilities, Mode=OneTime, Converter={StaticResource AbilityToViewModelValueConverter}}" ItemTemplate="{StaticResource StandaloneAbilityView}" Margin="0 0 8 0" Focusable="False"/>
                <ItemsControl Grid.Column="3" ItemsSource="{Binding ArmorSetSkills, Mode=OneTime}" ItemTemplate="{StaticResource ArmorSetSkillView}" Margin="0 0 8 0" Focusable="False"/>
                <ItemsControl x:Name="craftMaterials" Grid.Row="1" Grid.ColumnSpan="3" ItemsSource="{Binding CraftMaterials, Mode=OneTime}" Visibility="Collapsed">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding}" ContentTemplate="{StaticResource CraftMaterialView}" Margin="1 1 18 1"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </Grid>
        </Border>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding ShowIsPossessed, Mode=OneTime}" Value="True">
                <Setter TargetName="possessedIcon" Property="Visibility" Value="Visible"/>
                <Setter TargetName="craftMaterials" Property="Visibility" Value="Visible"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding IsPossessed}" Value="False">
                <Setter TargetName="possessedIcon" Property="Opacity" Value="0.1"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <BlurBitmapEffect x:Key="blur" KernelType="Gaussian" Radius="12"/>

    <DataTemplate x:Key="SearchResultArmorSetDetailsView">
        <StackPanel>
            <StackPanel x:Name="deco">
                <TextBlock Text="Required decorations:" FontWeight="Bold"/>
                <ItemsControl ItemsSource="{Binding Jewels, Mode=OneTime}" Margin="16 1 0 12" Focusable="False">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Image Source="{Binding Jewel.SlotSize, Converter={StaticResource SlotToImageSourceValueConverter}, ConverterParameter=16, Mode=OneTime}" Width="16" Height="16" SnapsToDevicePixels="True" VerticalAlignment="Center"/>
                                <TextBlock VerticalAlignment="Center" Margin="1 0 0 3">
                                    <Run Text="{mxt:Localization Jewel.Name}"/>
                                    <Run Text="{Binding Count, Mode=OneTime, StringFormat=x{0}}" Foreground="Blue"/>
                                </TextBlock>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
            <StackPanel x:Name="def">
                <TextBlock Text="Defenses:" FontWeight="Bold"/>
                <StackPanel Margin="16 1 0 12">
                    <TextBlock>
                        <Run Text="Base: "/>
                        <Run Text="{Binding TotalBaseDefense, Mode=OneTime}" Foreground="Blue"/>
                    </TextBlock>
                    <TextBlock>
                        <Run Text="Maximum: "/>
                        <Run Text="{Binding TotalMaxDefense, Mode=OneTime}" Foreground="Blue"/>
                    </TextBlock>
                    <TextBlock>
                        <Run Text="Augmented: "/>
                        <Run Text="{Binding TotalAugmentedDefense, Mode=OneTime}" Foreground="Blue"/>
                    </TextBlock>
                </StackPanel>
            </StackPanel>
            <StackPanel x:Name="slots">
                <TextBlock Text="Spare slots:" FontWeight="Bold"/>
                <StackPanel Orientation="Horizontal" Margin="16 1 0 12">
                    <Image Source="{mxt:RasterizedImage Location=Icons/Jewels/Jewel3.svg, Size=16}" Style="{StaticResource ComboBoxItemSlotStyle}"/>
                    <TextBlock Text="{Binding SpareSlots[2], Mode=OneTime, StringFormat=x{0}}" Margin="2 0 8 0" Foreground="Blue"/>
                    <Image Source="{mxt:RasterizedImage Location=Icons/Jewels/Jewel2.svg, Size=16}" Style="{StaticResource ComboBoxItemSlotStyle}"/>
                    <TextBlock Text="{Binding SpareSlots[1], Mode=OneTime, StringFormat=x{0}}" Margin="2 0 8 0" Foreground="Blue"/>
                    <Image Source="{mxt:RasterizedImage Location=Icons/Jewels/Jewel1.svg, Size=16}" Style="{StaticResource ComboBoxItemSlotStyle}"/>
                    <TextBlock Text="{Binding SpareSlots[0], Mode=OneTime, StringFormat=x{0}}" Margin="2 0 8 0" Foreground="Blue"/>
                </StackPanel>
            </StackPanel>
            <StackPanel x:Name="skills">
                <TextBlock Text="Additional skills:" FontWeight="Bold"/>
                <ItemsControl ItemsSource="{Binding AdditionalSkills, Mode=OneTime}" Margin="16 1 0 12" Focusable="False">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <TextBlock HorizontalAlignment="Left">
                                <bhv:ToolTipEx.Content>
                                    <ContentControl Content="{Binding Description, Mode=OneTime}" ContentTemplate="{StaticResource FullSkillDescriptionView}"/>
                                </bhv:ToolTipEx.Content>
                                <Run Text="{mxt:Localization Skill.Name}" x:Name="skillName"/>
                                <Run Text=": "/>
                                <Run Text="{Binding TotalLevel, Mode=OneTime}" Foreground="Blue"/>
                                <Run Text="/"/>
                                <Run Text="{Binding Skill.MaxLevel, Mode=OneTime}"/>
                            </TextBlock>
                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding IsExtra, Mode=OneTime}" Value="False">
                                    <Setter TargetName="skillName" Property="TextBlock.Foreground" Value="#FFAE00FF"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsOver, Mode=OneTime}" Value="True">
                                    <Setter TargetName="skillName" Property="TextBlock.Foreground" Value="Red"/>
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
            <StackPanel x:Name="res">
                <TextBlock Text="Resistances:" FontWeight="Bold"/>
                <StackPanel Margin="16 1 0 0" Orientation="Horizontal">
                    <StackPanel Margin="0 0 12 0">
                        <Image Source="{mxt:RasterizedImage Location=Icons/Elements/Fire.svg, Size=16}" Style="{StaticResource ElementImageStyle}" HorizontalAlignment="Center" SnapsToDevicePixels="True"/>
                        <TextBlock Text="{Binding TotalFireResistance, Mode=OneTime}" HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Margin="0 0 12 0">
                        <Image Source="{mxt:RasterizedImage Location=Icons/Elements/Water.svg, Size=16}" Style="{StaticResource ElementImageStyle}" HorizontalAlignment="Center" SnapsToDevicePixels="True"/>
                        <TextBlock Text="{Binding TotalWaterResistance, Mode=OneTime}" HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Margin="0 0 12 0">
                        <Image Source="{mxt:RasterizedImage Location=Icons/Elements/Thunder.svg, Size=16}" Style="{StaticResource ElementImageStyle}" HorizontalAlignment="Center" SnapsToDevicePixels="True"/>
                        <TextBlock Text="{Binding TotalThunderResistance, Mode=OneTime}" HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Margin="0 0 12 0">
                        <Image Source="{mxt:RasterizedImage Location=Icons/Elements/Ice.svg, Size=16}" Style="{StaticResource ElementImageStyle}" HorizontalAlignment="Center" SnapsToDevicePixels="True"/>
                        <TextBlock Text="{Binding TotalIceResistance, Mode=OneTime}" HorizontalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Margin="0 0 12 0">
                        <Image Source="{mxt:RasterizedImage Location=Icons/Elements/Dragon.svg, Size=16}" Style="{StaticResource ElementImageStyle}" HorizontalAlignment="Center" SnapsToDevicePixels="True"/>
                        <TextBlock Text="{Binding TotalDragonResistance, Mode=OneTime}" HorizontalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </StackPanel>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding HasRequiredDecorations, Mode=OneTime}" Value="False">
                <Setter TargetName="deco" Property="BitmapEffect" Value="{StaticResource blur}"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding HasDefense, Mode=OneTime}" Value="False">
                <Setter TargetName="def" Property="BitmapEffect" Value="{StaticResource blur}"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding HasSpareSlots, Mode=OneTime}" Value="False">
                <Setter TargetName="slots" Property="BitmapEffect" Value="{StaticResource blur}"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding HasAdditionalSkills, Mode=OneTime}" Value="False">
                <Setter TargetName="skills" Property="BitmapEffect" Value="{StaticResource blur}"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding HasResistances, Mode=OneTime}" Value="False">
                <Setter TargetName="res" Property="BitmapEffect" Value="{StaticResource blur}"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="SearchResultArmorSetView">
        <Border Style="{StaticResource ThickResultBorderStyle}">
            <Border.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Take screenshot (save to clipboard)" Command="{Binding SaveScreenshotToClipboardCommand, Mode=OneTime}"/>
                    <MenuItem Header="Take screenshot (save to file)" Command="{Binding SaveScreenshotToFileCommand, Mode=OneTime}"/>
                    <Separator/>
                    <MenuItem Header="Copy to text (save to clipboard)" Command="{Binding SaveTextToClipboardCommand, Mode=OneTime}"/>
                    <MenuItem Header="Copy to text (save to file)" Command="{Binding SaveTextToFileCommand, Mode=OneTime}"/>
                </ContextMenu>
            </Border.ContextMenu>
            <DockPanel LastChildFill="True">
                <StackPanel DockPanel.Dock="Left" Orientation="Vertical" Grid.IsSharedSizeScope="True">
                    <ItemsControl ItemsSource="{Binding ArmorPieces, Mode=OneTime}" ItemTemplate="{StaticResource ArmorPieceView}" Focusable="False"/>
                    <ContentControl Content="{Binding Charm, Mode=OneTime}" ContentTemplate="{StaticResource ArmorPieceView}" Focusable="False"/>
                </StackPanel>
                <Border DockPanel.Dock="Right" Visibility="{Binding Parent.ShowCraftMaterials, Converter={StaticResource CollapsedVisibilityValueConverter}}" Style="{StaticResource ThinResultBorderStyle}" HorizontalAlignment="Right">
                    <ItemsControl ItemsSource="{Binding CraftMaterials}" ItemTemplate="{StaticResource CraftMaterialView}" Focusable="False"/>
                </Border>
                <Border Style="{StaticResource ThinResultBorderStyle}" HorizontalAlignment="Stretch">
                    <ContentControl Content="{Binding}" ContentTemplate="{StaticResource SearchResultArmorSetDetailsView}" Focusable="False"/>
                </Border>
            </DockPanel>
        </Border>
    </DataTemplate>

    <DataTemplate x:Key="SkillNameAbilityView">
        <StackPanel Orientation="Horizontal">
            <TextBlock Text="{mxt:Localization SkillName}" Focusable="False"/>
            <TextBlock Text="{Binding MaxLevel, Mode=OneTime, StringFormat=' (max: {0})'}" Focusable="False"/>
            <bhv:ToolTipEx.Content>
                <ContentControl Content="{Binding Description, Mode=OneTime}" ContentTemplate="{StaticResource FullSkillDescriptionView}"/>
            </bhv:ToolTipEx.Content>
        </StackPanel>
    </DataTemplate>

    <DataTemplate x:Key="SkillView">
        <Border x:Name="root" BorderBrush="Gray" BorderThickness="0 0 0 0" IsEnabled="{Binding IsAvailable}">
            <StackPanel Orientation="Vertical" Focusable="False">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{mxt:Localization Name}" FontSize="12" FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding JewelsText, Mode=OneWay}" Margin="4 0 0 0" FontSize="11" Foreground="DarkGray" FontStyle="Italic" VerticalAlignment="Center"/>
                </StackPanel>
                <TextBlock Text="{mxt:Localization Description}" Foreground="DarkGray" Padding="32 0 5 5"/>
                <ItemsControl ItemsSource="{Binding Abilities, Mode=OneTime}" Focusable="False" Margin="32 0 0 0">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel x:Name="ability" Orientation="Horizontal" Focusable="False">
                                <CheckBox Focusable="False" HorizontalContentAlignment="Left" Content="{Binding}" ContentTemplate="{StaticResource AbilityView}" Margin="0" Padding="5 3 5 3" IsChecked="{Binding IsChecked, Mode=TwoWay}" VerticalContentAlignment="Center"/>
                            </StackPanel>
                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding IsHidden, Mode=OneWay}" Value="True">
                                    <Setter TargetName="ability" Property="Opacity" Value="0.25"/>
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsAvailable}" Value="False">
                <Setter TargetName="root" Property="TextBlock.Foreground" Value="Red"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <Style x:Key="SelectorRadioButton" TargetType="RadioButton" BasedOn="{StaticResource {x:Type ToggleButton}}">
        <Setter Property="Margin" Value="2"/>
        <Setter Property="Padding" Value="4"/>
        <Setter Property="MinWidth" Value="50"/>
        <Setter Property="VerticalAlignment" Value="Center"/>
        <Style.Triggers>
            <Trigger Property="IsChecked" Value="True">
                <Setter Property="FontWeight" Value="Bold"/>
            </Trigger>
        </Style.Triggers>
    </Style>

    <DataTemplate x:Key="SkillSelectorView">
        <DockPanel LastChildFill="True">
            <StackPanel DockPanel.Dock="Top">
                <DockPanel LastChildFill="True">
                    <TextBlock DockPanel.Dock="Left" Text="Filter: " Margin="4" VerticalAlignment="Center"/>
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                        <RadioButton Content="All" IsChecked="{Binding VisibilityModeAll, Mode=OneWayToSource, FallbackValue=true}" bhv:ToolTipEx.Content="See all available skills" Style="{StaticResource SelectorRadioButton}"/>
                        <RadioButton Content="Selected" IsChecked="{Binding VisibilityModeSelected, Mode=OneWayToSource}" bhv:ToolTipEx.Content="See only selected skills" Style="{StaticResource SelectorRadioButton}"/>
                        <RadioButton Content="Unselected" IsChecked="{Binding VisibilityModeUnselected, Mode=OneWayToSource}" bhv:ToolTipEx.Content="See only unselected skills" Style="{StaticResource SelectorRadioButton}"/>
                    </StackPanel>
                    <TextBox Margin="2" Padding="3" FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" bhv:TextBoxFocusOnEmptyBehavior.IsAttached="True" bhv:CommandOnEnterKeyBehavior.Command="{Binding SearchTextBasedSkillLevelSetCommand, Mode=OneTime}"/>
                </DockPanel>
                <ItemsControl ItemsSource="{Binding Categories, Mode=OneWay}" Margin="0 2 0 2" HorizontalAlignment="Right" Focusable="False">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <CheckBox IsChecked="{Binding Value}" Content="{Binding Name, Mode=OneTime}" VerticalAlignment="Center" VerticalContentAlignment="Center" Margin="4 2 4 2"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </StackPanel>
            <ListBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" ItemsSource="{Binding Skills, Mode=OneWay}" ItemTemplate="{StaticResource SkillView}" VirtualizingPanel.IsVirtualizing="False" VirtualizingPanel.ScrollUnit="Pixel" Focusable="False">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="{x:Type ListBoxItem}">
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type ListBoxItem}">
                                    <Border Name="root" Padding="2" SnapsToDevicePixels="True" Focusable="False">
                                        <ContentPresenter Focusable="False"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <DataTrigger Binding="{Binding IsVisible}" Value="False">
                                            <Setter TargetName="root" Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Focusable" Value="False"/>
                    </Style>
                </ListBox.ItemContainerStyle>
            </ListBox>
        </DockPanel>
    </DataTemplate>

    <DataTemplate x:Key="JewelOverrideView">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" SharedSizeGroup="A"/>
                <ColumnDefinition Width="Auto" SharedSizeGroup="B"/>
                <ColumnDefinition Width="Auto" SharedSizeGroup="C"/>
            </Grid.ColumnDefinitions>
            <CheckBox Grid.Column="0" IsChecked="{Binding IsOverriding}" Padding="4" VerticalAlignment="Stretch" VerticalContentAlignment="Center" bhv:ToolTipEx.Content="Check to override default jewel availability">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{mxt:Localization Name}" VerticalAlignment="Center" Margin="0 0 4 0"/>
                    <Image Source="{Binding SlotSize, Converter={StaticResource SlotToImageSourceValueConverter}, ConverterParameter=24, Mode=OneTime}" VerticalAlignment="Center" bhv:ToolTipEx.Content="{Binding SlotSize, Converter={StaticResource SlotSizeToolTipValueConverter}, Mode=OneTime}" Width="24" Height="24" SnapsToDevicePixels="True"/>
                </StackPanel>
            </CheckBox>
            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top" Margin="4">
                <TextBlock Text="Count: " VerticalAlignment="Center" Margin="2 0 2 0"/>
                <TextBox Text="{Binding Count, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="2 0 2 0" Padding="2" Width="60" VerticalAlignment="Center"/>
            </StackPanel>
            <ItemsControl x:Name="lst" Grid.Column="2" ItemsSource="{Binding Abilities, Mode=OneTime}" ItemTemplate="{StaticResource SkillNameAbilityView}" VerticalAlignment="Top" Padding="4" Focusable="False"/>
        </Grid>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding HasAllJewels, Mode=OneWay}" Value="True">
                <Setter TargetName="lst" Property="TextBlock.Foreground" Value="Blue"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding HasTooManyJewels, Mode=OneWay}" Value="True">
                <Setter TargetName="lst" Property="TextBlock.Foreground" Value="DarkOrange"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="DecorationsOverrideView">
        <DockPanel LastChildFill="True">
            <DockPanel DockPanel.Dock="Top" LastChildFill="True">
                <TextBlock DockPanel.Dock="Left" Text="Filter: " Margin="4" VerticalAlignment="Center"/>
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <StackPanel.Resources>
                        <Style TargetType="RadioButton">
                            <Setter Property="MinWidth" Value="0"/>
                            <Setter Property="Margin" Value="2 2 8 2"/>
                        </Style>
                    </StackPanel.Resources>
                    <RadioButton Content="All" IsChecked="{Binding VisibilityModeAll, Mode=OneWayToSource, FallbackValue=true}" bhv:ToolTipEx.Content="See all available jewels" Style="{StaticResource SelectorRadioButton}"/>
                    <RadioButton Content="Modified" IsChecked="{Binding VisibilityModeModified, Mode=OneWayToSource}" bhv:ToolTipEx.Content="See only jewels with override checkbox checked or a count greater than zero" Style="{StaticResource SelectorRadioButton}"/>
                    <RadioButton Content="Unmodified" IsChecked="{Binding VisibilityModeUnmodified, Mode=OneWayToSource}" bhv:ToolTipEx.Content="See only jewels with override checkbox unchecked and a count of zero" Style="{StaticResource SelectorRadioButton}"/>
                    <Button Content="?" MinWidth="20" Margin="2" Padding="4" VerticalAlignment="Center" Command="{Binding OpenIntegratedHelpCommand, Mode=OneTime}" CommandParameter="DecorationsOverride" IsEnabled="True" bhv:ToolTipEx.Content="Show help about decorations override"/>
                </StackPanel>
                <TextBox Margin="2" Padding="3" FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" bhv:TextBoxFocusOnEmptyBehavior.IsAttached="True"/>
            </DockPanel>
            <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal">
                <Button Margin="1" Padding="8" Content="Import from save..." Command="{Binding ImportCommand, Mode=OneTime}"/>
            </StackPanel>
            <ListBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" ItemsSource="{Binding Jewels, Mode=OneWay}" ItemTemplate="{StaticResource JewelOverrideView}" VirtualizingPanel.IsVirtualizing="False" VirtualizingPanel.ScrollUnit="Pixel" Grid.IsSharedSizeScope="True" Focusable="False">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="{x:Type ListBoxItem}">
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type ListBoxItem}">
                                    <Border Name="root" Padding="0" SnapsToDevicePixels="True" Focusable="False">
                                        <ContentPresenter Focusable="False"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <DataTrigger Binding="{Binding IsVisible}" Value="False">
                                            <Setter TargetName="root" Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Focusable" Value="False"/>
                    </Style>
                </ListBox.ItemContainerStyle>
            </ListBox>
        </DockPanel>
    </DataTemplate>

    <DataTemplate x:Key="EquipmentItemOverrideView">
        <Button x:Name="toggle" Command="{Binding TogglePossessionCommand, Mode=OneTime}" Background="{StaticResource ActiveWeaponBackgroundBrush}" VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
            <bhv:ToolTipEx.Content>
                <ContentControl Content="{Binding Mode=OneTime}" ContentTemplate="{StaticResource ArmorPieceView}" Focusable="False"/>
            </bhv:ToolTipEx.Content>
            <Button.Content>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Image Source="{Binding Type, Mode=OneTime, Converter={StaticResource EquipmentEnumToImageSourceValueConverter}, ConverterParameter=32}" Width="32" Height="32" Margin="1" Focusable="False"/>
                    <Image x:Name="icon" Source="{mxt:RasterizedImage Location=Icons/Others/cube_chest.svg, Size=16}" Width="16" Height="16" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="-5" IsHitTestVisible="False" SnapsToDevicePixels="True"/>
                </Grid>
            </Button.Content>
        </Button>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding}" Value="{x:Null}">
                <Setter TargetName="toggle" Property="Visibility" Value="Hidden"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding IsPossessed}" Value="False">
                <Setter TargetName="toggle" Property="Background" Value="{StaticResource InactiveToggleBackgroundBrush}"/>
                <Setter TargetName="icon" Property="Visibility" Value="Hidden"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="ArmorSetsOverrideView">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" SharedSizeGroup="ArmorSetNameColumn"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="{mxt:Localization Name}" Padding="4" VerticalAlignment="Center" FontWeight="Bold" FontSize="14"/>
            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Width="16" Margin="4" bhv:ToolTipEx.Content="Toggle all" Command="{Binding ToggleAllCommand, Mode=OneTime}"/>
                <ItemsControl ItemsSource="{Binding OrderedEquipments, Mode=OneTime}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding Mode=OneTime}" Margin="4" ContentTemplate="{StaticResource EquipmentItemOverrideView}" Focusable="False"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Grid>
    </DataTemplate>

    <DataTemplate x:Key="EquipmentOverrideView">
        <DockPanel LastChildFill="True">
            <StackPanel DockPanel.Dock="Top">
                <DockPanel LastChildFill="True">
                    <TextBlock DockPanel.Dock="Left" Text="Filter: " Margin="4" VerticalAlignment="Center"/>
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                        <StackPanel.Resources>
                            <Style TargetType="RadioButton">
                                <Setter Property="MinWidth" Value="0"/>
                                <Setter Property="Margin" Value="2 2 8 2"/>
                            </Style>
                        </StackPanel.Resources>
                        <TextBlock Text="Show: " VerticalAlignment="Center" Margin="2"/>
                        <ComboBox VerticalAlignment="Center" Margin="2" SelectedIndex="{Binding VisibilityMode, FallbackValue=0}" MinWidth="120">
                            <TextBlock Text="All" bhv:ToolTipEx.Content="See all available sets"/>
                            <TextBlock Text="All possessed" bhv:ToolTipEx.Content="See all sets where all pieces are possessed"/>
                            <TextBlock Text="Some possessed" bhv:ToolTipEx.Content="See only sets where at least one piece is possessed"/>
                            <TextBlock Text="Some unpossessed" bhv:ToolTipEx.Content="See only sets where no piece is possessed"/>
                            <TextBlock Text="All unpossessed" bhv:ToolTipEx.Content="See only sets where no piece is possessed"/>
                        </ComboBox>
                        <Button Content="?" MinWidth="20" Margin="2" Padding="4" VerticalAlignment="Center" Command="{Binding OpenIntegratedHelpCommand, Mode=OneTime}" CommandParameter="EquipmentOverride" IsEnabled="True" bhv:ToolTipEx.Content="Show help about equipment override"/>
                    </StackPanel>
                    <TextBox Margin="2" Padding="3" FocusManager.FocusedElement="{Binding RelativeSource={RelativeSource Self}}" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" bhv:TextBoxFocusOnEmptyBehavior.IsAttached="True"/>
                </DockPanel>
                <UniformGrid Columns="2">
                    <Button Content="Select all" Command="{Binding SelectAllCommand, Mode=OneTime}" Padding="4" Margin="2"/>
                    <Button Content="Unselect all" Command="{Binding UnselectAllCommand, Mode=OneTime}" Padding="4" Margin="2"/>
                </UniformGrid>
            </StackPanel>
            <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal">
                <Button Margin="1" Padding="8" Content="Import from save..." Command="{Binding ImportCommand, Mode=OneTime}"/>
            </StackPanel>
            <TextBlock DockPanel.Dock="Bottom" Text="{Binding Status}" HorizontalAlignment="Stretch" Margin="3"/>
            <ListBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" ItemsSource="{Binding AllEquipments, Mode=OneWay}" ItemTemplate="{StaticResource ArmorSetsOverrideView}" VirtualizingPanel.IsVirtualizing="False" VirtualizingPanel.ScrollUnit="Pixel" Grid.IsSharedSizeScope="True" Focusable="False">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="{x:Type ListBoxItem}">
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type ListBoxItem}">
                                    <Border Name="root" Padding="0" SnapsToDevicePixels="True" Focusable="False">
                                        <ContentPresenter Focusable="False"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <DataTrigger Binding="{Binding IsVisible}" Value="False">
                                            <Setter TargetName="root" Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Focusable" Value="False"/>
                    </Style>
                </ListBox.ItemContainerStyle>
            </ListBox>
        </DockPanel>
    </DataTemplate>

    <DataTemplate x:Key="SearchMetricsView">
        <DataTemplate.Resources>
            <Style x:Key="highlight" TargetType="TextBlock">
                <Setter Property="Foreground" Value="Blue"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
            </Style>
            <Style TargetType="TextBlock">
                <Setter Property="Margin" Value="1 1 4 1"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
            </Style>
        </DataTemplate.Resources>
        <Expander x:Name="root" ExpandDirection="Up" IsExpanded="False">
            <Expander.Header>
                <StackPanel x:Name="header" Orientation="Horizontal">
                    <TextBlock Text="Combinations: "/>
                    <TextBlock Text="{Binding CombinationCount, Converter={StaticResource NumToSeparatedStringValueConverter}, Mode=OneTime}" Margin="0 0 16 0" Style="{StaticResource highlight}"/>
                    <TextBlock Text="Matching results: "/>
                    <TextBlock Text="{Binding MatchingResults, Converter={StaticResource NumToSeparatedStringValueConverter}, Mode=OneTime}" Margin="0 0 16 0" Style="{StaticResource highlight}"/>
                    <TextBlock Text="Time: "/>
                    <TextBlock Text="{Binding TimeElapsed, Converter={StaticResource MillisecondsToTimeValueConverter}, Mode=OneTime}" bhv:ToolTipEx.Content="{Binding TimeElapsed}" Margin="0 0 16 0" Style="{StaticResource highlight}"/>
                    <TextBlock Text="Combination/sec: "/>
                    <TextBlock Text="{Binding Converter={StaticResource CombinationPerSecondValueConverter}, Mode=OneTime}" Margin="0 0 16 0" Style="{StaticResource highlight}"/>
                </StackPanel>
            </Expander.Header>
            <Expander.Content>
                <StackPanel Orientation="Horizontal" Margin="1 1 1 4">
                    <StackPanel.Resources>
                        <Style TargetType="Border">
                            <Setter Property="BorderThickness" Value="2"/>
                            <Setter Property="BorderBrush" Value="#20000000"/>
                            <Setter Property="CornerRadius" Value="2"/>
                            <Setter Property="Margin" Value="16 0 0 0"/>
                            <Setter Property="Padding" Value="4"/>
                            <Setter Property="Background" Value="#10000000"/>
                        </Style>
                    </StackPanel.Resources>
                    <Border Margin="0">
                        <StackPanel Orientation="Horizontal">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Heads:"/>
                                    <TextBlock Text="{Binding Heads, Mode=OneTime}" Style="{StaticResource highlight}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Chests:"/>
                                    <TextBlock Text="{Binding Chests, Mode=OneTime}" Style="{StaticResource highlight}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Gloves:"/>
                                    <TextBlock Text="{Binding Gloves, Mode=OneTime}" Style="{StaticResource highlight}"/>
                                </StackPanel>
                            </StackPanel>
                            <StackPanel Margin="16 0 0 0">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Waists:"/>
                                    <TextBlock Text="{Binding Waists, Mode=OneTime}" Style="{StaticResource highlight}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Legs:"/>
                                    <TextBlock Text="{Binding Legs, Mode=OneTime}" Style="{StaticResource highlight}"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Charms:"/>
                                    <TextBlock Text="{Binding Charms, Mode=OneTime}" Style="{StaticResource highlight}"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    <Border>
                        <StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Min slot size:"/>
                                <TextBlock Text="{Binding MinSlotSize, Mode=OneTime}" Style="{StaticResource highlight}"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Max slot size:"/>
                                <TextBlock Text="{Binding MaxSlotSize, Mode=OneTime}" Style="{StaticResource highlight}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    <Border>
                        <StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Combinations:"/>
                                <TextBlock Text="{Binding CombinationCount, Converter={StaticResource NumToSeparatedStringValueConverter}, Mode=OneTime}" Style="{StaticResource highlight}"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Matching results:"/>
                                <TextBlock Text="{Binding MatchingResults, Converter={StaticResource NumToSeparatedStringValueConverter}, Mode=OneTime}" Style="{StaticResource highlight}"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Time:"/>
                                <TextBlock Text="{Binding TimeElapsed, Converter={StaticResource MillisecondsToTimeValueConverter}, Mode=OneTime}" bhv:ToolTipEx.Content="{Binding TimeElapsed}" Style="{StaticResource highlight}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                    <Border>
                        <StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Combination/sec:"/>
                                <TextBlock Text="{Binding Converter={StaticResource CombinationPerSecondValueConverter}, Mode=OneTime}" Style="{StaticResource highlight}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Expander.Content>
        </Expander>
        <DataTemplate.Triggers>
            <Trigger SourceName="root" Property="IsExpanded" Value="True">
                <Setter TargetName="header" Property="Visibility" Value="Collapsed"/>
            </Trigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="AutoUpdateView">
        <TextBlock VerticalAlignment="Center" Text="{Binding ShortText, Mode=OneWay}" Visibility="{Binding IsVisible, Mode=OneWay, Converter={StaticResource CollapsedVisibilityValueConverter}}" Foreground="Red" FontWeight="Bold" Margin="0 0 6 0" bhv:ToolTipEx.Content="{Binding DetailedText, Mode=OneWay}">
            <TextBlock.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Acknowledge" Command="{Binding AcknowledgeCommand, Mode=OneTime}"/>
                    <MenuItem Header="Download" Command="{Binding DownloadCommand, Mode=OneTime}"/>
                </ContextMenu>
            </TextBlock.ContextMenu>
        </TextBlock>
    </DataTemplate>

    <DataTemplate x:Key="LanguageView">
        <TextBlock Text="{Binding Text, Mode=OneTime}"/>
    </DataTemplate>

    <DataTemplate x:Key="GroupedSearchResultsView">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <!-- Cannot use ListBox here because of virtualization and variable item height :( -->
            <ItemsControl Grid.Column="0" bhv:SelectionChangedViewNotifierBehavior.IsAttached="True" ItemsSource="{Binding GroupedFoundArmorSets, Mode=OneWay}" Visibility="{Binding HasGroupedResults, Mode=OneWay, Converter={StaticResource CollapsedVisibilityValueConverter}}" ctrl:CustomScrollViewer.IsScrollEnabled="{Binding IsMasterViewUnlocked, Mode=OneWay}" ctrl:CustomScrollViewer.VerticalScrollBarVisibility="{Binding IsMasterViewUnlocked, Mode=OneWay, Converter={StaticResource ScrollBarVisibilityValueConverter}}" ClipToBounds="False" Padding="0 0 0 0" Focusable="False" VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.ScrollUnit="Pixel" ScrollViewer.CanContentScroll="True">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <VirtualizingStackPanel Margin="0 0 6 0"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <ItemContainerTemplate>
                        <Button Style="{StaticResource SeamlessButtonStyle}" Command="{Binding SelectionCommand, Mode=OneTime}" Focusable="False">
                            <StackPanel Focusable="False">
                                <TextBlock Text="Scroll locked, click to unlock" FontWeight="Bold" Foreground="Goldenrod" HorizontalAlignment="Center" Visibility="{Binding IsSelected, Mode=OneWay, Converter={StaticResource HiddenVisibilityValueConverter}}"/>
                                <Border x:Name="root" Style="{StaticResource ThickResultBorderStyle}" Margin="2" Padding="2" SnapsToDevicePixels="True" Focusable="False" Opacity="0.4">
                                    <ContentControl Content="{Binding Mode=OneTime}" ContentTemplate="{StaticResource SearchResultArmorSetDetailsView}" Margin="4" Focusable="False"/>
                                </Border>
                            </StackPanel>
                        </Button>
                        <ItemContainerTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="root" Property="Opacity" Value="0.6"/>
                            </Trigger>
                            <DataTrigger Binding="{Binding IsSelected, Mode=OneWay}" Value="True">
                                <Setter TargetName="root" Property="Opacity" Value="1.0"/>
                                <Setter TargetName="root" Property="Style" Value="{StaticResource SelectedThickResultBorderStyle}"/>
                            </DataTrigger>
                        </ItemContainerTemplate.Triggers>
                    </ItemContainerTemplate>
                </ItemsControl.ItemTemplate>
                <ItemsControl.Template>
                    <ControlTemplate>
                        <ctrl:CustomScrollViewer Style="{StaticResource CustomVerticalScrollViewerStyle}" Padding="{TemplateBinding Control.Padding}" Focusable="False">
                            <ItemsPresenter SnapsToDevicePixels="{TemplateBinding UIElement.SnapsToDevicePixels}" />
                        </ctrl:CustomScrollViewer>
                    </ControlTemplate>
                </ItemsControl.Template>
            </ItemsControl>
            <ItemsControl Grid.Column="1" ItemsSource="{Binding SelectedGroup.Items, Mode=OneWay}" ItemTemplate="{StaticResource SearchResultArmorSetView}" ScrollViewer.VerticalScrollBarVisibility="Visible" ScrollViewer.HorizontalScrollBarVisibility="Auto" ClipToBounds="True" Padding="0 0 0 -22" Focusable="False" VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.ScrollUnit="Pixel" ScrollViewer.CanContentScroll="True">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <VirtualizingStackPanel/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.Template>
                    <ControlTemplate>
                        <ScrollViewer Padding="{TemplateBinding Control.Padding}" Focusable="False">
                            <ItemsPresenter SnapsToDevicePixels="{TemplateBinding UIElement.SnapsToDevicePixels}" />
                        </ScrollViewer>
                    </ControlTemplate>
                </ItemsControl.Template>
            </ItemsControl>
        </Grid>
    </DataTemplate>

    <DataTemplate x:Key="UngroupedSearchResultsView">
        <ItemsControl ItemsSource="{Binding Mode=OneTime}" ItemTemplate="{StaticResource SearchResultArmorSetView}" ScrollViewer.VerticalScrollBarVisibility="Visible" ScrollViewer.HorizontalScrollBarVisibility="Auto" ClipToBounds="True" Padding="0 0 0 -22" Focusable="False" VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.ScrollUnit="Pixel" ScrollViewer.CanContentScroll="True">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <VirtualizingStackPanel/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.Template>
                <ControlTemplate>
                    <ScrollViewer Padding="{TemplateBinding Control.Padding}" Focusable="False">
                        <ItemsPresenter SnapsToDevicePixels="{TemplateBinding UIElement.SnapsToDevicePixels}" />
                    </ScrollViewer>
                </ControlTemplate>
            </ItemsControl.Template>
        </ItemsControl>
    </DataTemplate>

    <DataTemplate x:Key="SearchResultsView">
        <Grid>
            <TextBlock x:Name="loading" Text="Loading..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="24" Foreground="DarkGray" FontWeight="Bold" Visibility="{Binding IsDataLoading, Converter={StaticResource CollapsedVisibilityValueConverter}, Mode=OneWay}"/>
            <DockPanel LastChildFill="True">
                <DockPanel DockPanel.Dock="Top">
                    <CheckBox DockPanel.Dock="Left" Content="Show craft materials" IsChecked="{Binding ShowCraftMaterials}" VerticalAlignment="Center"/>
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="0 4 0 4" HorizontalAlignment="Right" VerticalAlignment="Center">
                        <Button Content="?" MinWidth="20" Margin="2 2 6 2" Padding="2" VerticalAlignment="Center" Command="{x:Static local:RoutedCommands.OpenIntegratedHelp}" CommandParameter="Grouping" bhv:ToolTipEx.Content="Show help about grouping"/>
                        <TextBlock Text="Grouping: " VerticalAlignment="Center"/>
                        <ItemsControl ItemsSource="{Binding GroupFlags, Mode=OneTime}" VerticalAlignment="Center" Focusable="False">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox IsChecked="{Binding IsSet}" VerticalContentAlignment="Center" Margin="2">
                                        <TextBlock Text="{Binding Name, Mode=OneTime}" Margin="2"/>
                                    </CheckBox>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>
                </DockPanel>
                <Grid Visibility="{Binding IsDataLoaded, Converter={StaticResource CollapsedVisibilityValueConverter}, Mode=OneWay}">
                    <ContentControl x:Name="grouped" Content="{Binding Mode=OneWay}" ContentTemplate="{StaticResource GroupedSearchResultsView}" Focusable="False" Visibility="Hidden"/>
                    <ContentControl x:Name="ungrouped" Content="{Binding UngroupedFoundArmorSets, Mode=OneWay}" ContentTemplate="{StaticResource UngroupedSearchResultsView}" Focusable="False"/>
                </Grid>
            </DockPanel>
        </Grid>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsGroupedViewMode, Mode=OneWay}" Value="True">
                <Setter TargetName="grouped" Property="Visibility" Value="Visible"/>
                <Setter TargetName="ungrouped" Property="Visibility" Value="Hidden"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="RootView">
        <DockPanel LastChildFill="True">
            <DockPanel DockPanel.Dock="Top" LastChildFill="True">
                <Border DockPanel.Dock="Right" VerticalAlignment="Stretch" Background="{x:Static SystemColors.MenuBarBrush}">
                    <ContentControl Content="{Binding AutoUpdateViewModel, Mode=OneTime}" ContentTemplate="{StaticResource AutoUpdateView}" Focusable="False"/>
                </Border>
                <Menu FontSize="14">
                    <MenuItem Header="File">
                        <MenuItem Header="Close" Command="{Binding CloseApplicationCommand, Mode=OneTime}"/>
                    </MenuItem>
                    <MenuItem Header="Skill loadouts">
                        <MenuItem Header="New" Command="{x:Static ApplicationCommands.New}"/>
                        <MenuItem Header="Reset" Command="{x:Static local:RoutedCommands.ResetLoadout}"/>
                        <Separator/>
                        <MenuItem Header="Open..." Command="{x:Static ApplicationCommands.Open}"/>
                        <Separator/>
                        <MenuItem Header="Save" Command="{x:Static ApplicationCommands.Save}"/>
                        <MenuItem Header="Save as..." Command="{x:Static ApplicationCommands.SaveAs}"/>
                        <Separator/>
                        <MenuItem Header="Manage..." Command="{x:Static local:RoutedCommands.ManageLoadouts}"/>
                    </MenuItem>
                    <MenuItem Header="Equipments" Command="{x:Static local:RoutedCommands.OpenEquipmentExplorer}"/>
                    <MenuItem Header="Languages" ItemsSource="{Binding Languages, Mode=OneTime}" ItemTemplate="{StaticResource LanguageView}">
                        <MenuItem.ItemContainerStyle>
                            <Style TargetType="{x:Type MenuItem}">
                                <Setter Property="Command" Value="{Binding SelectionCommand, Mode=OneTime}"/>
                                <Setter Property="IsChecked" Value="{Binding IsChecked, Mode=OneWay}"/>
                            </Style>
                        </MenuItem.ItemContainerStyle>
                    </MenuItem>
                    <MenuItem Header="Extensions" Command="{x:Static local:RoutedCommands.OpenExtensions}"/>
                    <MenuItem Header="?">
                        <MenuItem Header="Integrated help" Command="{x:Static local:RoutedCommands.OpenIntegratedHelp}" CommandParameter="GettingStarted"/>
                        <Separator/>
                        <MenuItem Header="About..." Command="{Binding AboutCommand, Mode=OneTime}"/>
                    </MenuItem>
                </Menu>
            </DockPanel>
            <Border DockPanel.Dock="Top" Background="#0A000000" HorizontalAlignment="Stretch" Padding="1 4 1 4">
                <DockPanel>
                    <ContentControl DockPanel.Dock="Left" Content="{Binding InParameters, Mode=OneTime}" ContentTemplate="{StaticResource InParametersView}" Focusable="False"/>
                    <Button DockPanel.Dock="Right" HorizontalAlignment="Right" Content="Sort results..." Command="{Binding OpenSearchResultProcessingCommand, Mode=OneTime}" Margin="2" Padding="8" VerticalAlignment="Center"/>
                    <Button DockPanel.Dock="Right" HorizontalAlignment="Right" Content="?" MinWidth="20" Margin="2" Padding="4" VerticalAlignment="Center" Command="{x:Static local:RoutedCommands.OpenIntegratedHelp}" CommandParameter="Sorting" bhv:ToolTipEx.Content="Show help about sorting"/>
                </DockPanel>
            </Border>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="6"/>
                    <ColumnDefinition Width="4*"/>
                </Grid.ColumnDefinitions>
                <DockPanel Grid.Column="0" LastChildFill="True">
                    <Button DockPanel.Dock="Top" Content="Change skills" Margin="2" Padding="4" Command="{Binding OpenSkillSelectorCommand, Mode=OneTime}"/>
                    <CheckBox DockPanel.Dock="Bottom" Margin="2" Padding="2" IsChecked="{Binding IsAutoSearch}" IsThreeState="False" VerticalAlignment="Center" VerticalContentAlignment="Center">
                        <CheckBox.Content>
                            <TextBlock Text="Auto-search" VerticalAlignment="Center"/>
                        </CheckBox.Content>
                    </CheckBox>
                    <Button DockPanel.Dock="Bottom" Content="Advanced search..." Margin="2" Padding="4" Command="{Binding AdvancedSearchCommand, Mode=OneTime}"/>
                    <Grid DataContext="{Binding SearchResultsViewModel, Mode=OneTime}" DockPanel.Dock="Bottom">
                        <Button x:Name="btnSearch" Content="Search" Margin="2" Padding="4" Command="{Binding SearchArmorSetsCommand, Mode=OneTime}"/>
                        <Button x:Name="btnCancelSearch" Content="Cancel" Margin="2" Padding="4" Command="{Binding CancelArmorSetsSearchCommand, Mode=OneTime}" Visibility="Hidden"/>
                    </Grid>
                    <ProgressBar DockPanel.Dock="Bottom" HorizontalAlignment="Stretch" Margin="2" Padding="2" Minimum="0" Maximum="1" Value="{Binding SearchProgression, Mode=OneWay}" Visibility="{Binding IsSearching, Converter={StaticResource HiddenVisibilityValueConverter}}" Height="16"/>
                    <DockPanel LastChildFill="True">
                        <TextBlock Text="{Binding LoadoutText, Mode=OneWay}" FontSize="12" FontWeight="Bold" Foreground="Blue" Padding="3" DockPanel.Dock="Left" VerticalAlignment="Top" Background="#08000000">
                            <TextBlock.LayoutTransform>
                                <RotateTransform Angle="-90"/>
                            </TextBlock.LayoutTransform>
                        </TextBlock>
                        <ItemsControl ItemsSource="{Binding SelectedAbilities, Mode=OneWay}" ItemTemplate="{StaticResource SelectedAbilityView}" Margin="2" Padding="2" Focusable="False"/>
                    </DockPanel>
                </DockPanel>
                <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch"/>
                <DockPanel Grid.Column="2" LastChildFill="True">
                    <ContentControl DockPanel.Dock="Bottom" Content="{Binding SearchMetrics, Mode=OneWay}" ContentTemplate="{StaticResource SearchMetricsView}" Focusable="False"/>
                    <ContentControl Content="{Binding SearchResultsViewModel, Mode=OneTime}" ContentTemplate="{StaticResource SearchResultsView}" Focusable="False"/>
                </DockPanel>
            </Grid>
        </DockPanel>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsSearching, Mode=OneWay}" Value="True">
                <Setter TargetName="btnSearch" Property="Visibility" Value="Hidden"/>
                <Setter TargetName="btnCancelSearch" Property="Visibility" Value="Visible"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="ArmorPieceTypesView">
        <DockPanel LastChildFill="True" Background="#0F000000" Margin="4">
            <TextBlock DockPanel.Dock="Top" Text="{Binding Type, Mode=OneTime}" Margin="4"/>
            <TextBox DockPanel.Dock="Top" Text="{Binding SearchText, Mode=OneWayToSource, UpdateSourceTrigger=PropertyChanged}" Margin="1" Padding="2"/>
            <TextBlock DockPanel.Dock="Bottom" Margin="2" Text="{Binding Equipments.Count, Mode=OneTime, StringFormat=Total: {0}}"/>
            <TextBlock DockPanel.Dock="Bottom" Margin="2" Text="{Binding SelectedCount, StringFormat=Selected: {0}}"/>
            <Grid DockPanel.Dock="Bottom">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Button Grid.Column="0" Grid.Row="0" Command="{Binding SelectAllCommand, Mode=OneTime}" Margin="1">
                    <Viewbox StretchDirection="DownOnly">
                        <TextBlock Text="Select all" Margin="2"/>
                    </Viewbox>
                </Button>
                <Button Grid.Column="1" Grid.Row="0" Command="{Binding UnselectAllCommand, Mode=OneTime}" Margin="1">
                    <Viewbox StretchDirection="DownOnly">
                        <TextBlock Text="Unselect all" Margin="2"/>
                    </Viewbox>
                </Button>
                <Button Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="2" Command="{Binding InverseSelectionCommand, Mode=OneTime}" Margin="1">
                    <Viewbox StretchDirection="DownOnly">
                        <TextBlock Text="Inverse selection" Margin="2"/>
                    </Viewbox>
                </Button>
                <Button Grid.Column="0" Grid.Row="2" Grid.ColumnSpan="2" Command="{Binding ResetSelectionCommand, Mode=OneTime}" Margin="1" bhv:ToolTipEx.Content="Resest to default selection">
                    <Viewbox StretchDirection="DownOnly">
                        <TextBlock Text="Reset selection" Margin="2"/>
                    </Viewbox>
                </Button>
            </Grid>
            <ListBox ItemsSource="{Binding Equipments}" Margin="2" VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.IsContainerVirtualizable="True" VirtualizingPanel.ScrollUnit="Pixel">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="{x:Type ListBoxItem}">
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type ListBoxItem}">
                                    <ContentPresenter Name="root" Focusable="False"/>
                                    <ControlTemplate.Triggers>
                                        <DataTrigger Binding="{Binding IsVisible}" Value="False">
                                            <Setter TargetName="root" Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Focusable" Value="False"/>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <CheckBox IsThreeState="False" Padding="1" IsChecked="{Binding IsSelected}" Content="{mxt:Localization Equipment.Name}" VerticalContentAlignment="Center" Visibility="{Binding IsVisible, Mode=OneWay, Converter={StaticResource CollapsedVisibilityValueConverter}}">
                            <bhv:ToolTipEx.Content>
                                <ContentControl Content="{Binding Equipment, Mode=OneTime}" ContentTemplate="{StaticResource ArmorPieceView}" Focusable="False"/>
                            </bhv:ToolTipEx.Content>
                        </CheckBox>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </DockPanel>
    </DataTemplate>

    <DataTemplate x:Key="AdvancedSearchView">
        <DockPanel LastChildFill="True">
            <UniformGrid DockPanel.Dock="Bottom" Columns="2" Rows="1" HorizontalAlignment="Right">
                <Button Margin="4" Padding="4" Content="Export to clipboard" Command="{Binding ExportToClipboardCommand, Mode=OneTime}"/>
                <Button Margin="4" Padding="4" Content="Import from clipboard" Command="{Binding ImportFromClipboardCommand, Mode=OneTime}"/>
            </UniformGrid>
            <ItemsControl ItemsSource="{Binding ArmorPieceTypes}" ItemTemplate="{StaticResource ArmorPieceTypesView}" Focusable="False">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <UniformGrid Columns="6"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>
        </DockPanel>
    </DataTemplate>

    <DataTemplate x:Key="LoadoutView">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="{Binding Name, Mode=OneWay}" Focusable="False"/>
            <StackPanel x:Name="tools" Grid.Column="1" HorizontalAlignment="Right" Orientation="Horizontal" VerticalAlignment="Center" Visibility="{Binding IsManageMode, Converter={StaticResource CollapsedVisibilityValueConverter}}">
                <Button Content="Rename" Command="{Binding RenameCommand, Mode=OneTime}" Margin="1 0 1 0"/>
                <Button Width="{Binding ActualHeight, RelativeSource={RelativeSource Mode=Self}}" Content="Up" Command="{Binding MoveUpCommand, Mode=OneTime}" bhv:ToolTipEx.Content="Move up" Margin="1 0 1 0"/>
                <Button Width="{Binding ActualHeight, RelativeSource={RelativeSource Mode=Self}}" Content="Dn" Command="{Binding MoveDownCommand, Mode=OneTime}" bhv:ToolTipEx.Content="Move down" Margin="1 0 1 0"/>
                <Button Width="{Binding ActualHeight, RelativeSource={RelativeSource Mode=Self}}" Content="X" Command="{Binding DeleteCommand, Mode=OneTime}" bhv:ToolTipEx.Content="Delete" Margin="1 0 1 0"/>
            </StackPanel>
        </Grid>
    </DataTemplate>

    <DataTemplate x:Key="SlotImageView">
        <Image Source="{Binding Converter={StaticResource SlotToImageSourceValueConverter}, ConverterParameter=24, Mode=OneTime}" bhv:ToolTipEx.Content="{Binding Converter={StaticResource SlotSizeToolTipValueConverter}, Mode=OneTime}" Width="24" Height="24" SnapsToDevicePixels="True" />
    </DataTemplate>

    <DataTemplate x:Key="LoadoutSelectorView">

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="220"/>
                <ColumnDefinition Width="6"/>
                <ColumnDefinition Width="1.5*"/>
            </Grid.ColumnDefinitions>

            <DockPanel Grid.Column="0">
                <DockPanel DockPanel.Dock="Top">
                    <TextBlock DockPanel.Dock="Left" Text="Filter: " VerticalAlignment="Center" HorizontalAlignment="Left"/>
                    <TextBox x:Name="filter" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" Margin="2" Padding="3" VerticalAlignment="Center"/>
                </DockPanel>
                <ListBox x:Name="lst" SelectedItem="{Binding SelectedLoadout}" HorizontalContentAlignment="Stretch" ItemsSource="{Binding Loadouts, Mode=OneTime}" ItemTemplate="{StaticResource LoadoutView}" Margin="1">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="{x:Type ListBoxItem}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsVisible}" Value="False">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </DockPanel>

            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" Focusable="False"/>

            <DockPanel Grid.Column="2" LastChildFill="True">
                <StackPanel DockPanel.Dock="Top" Orientation="Horizontal">
                    <TextBlock Text="Weapon slots: " VerticalAlignment="Center"/>
                    <ItemsControl ItemsSource="{Binding SelectedLoadout.WeaponSlots}" ItemTemplate="{StaticResource SlotImageView}" VerticalAlignment="Center" Focusable="False">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </StackPanel>
                <ItemsControl ItemsSource="{Binding SelectedLoadout.Abilities}" ItemTemplate="{StaticResource StandaloneAbilityView}" Focusable="False"/>
            </DockPanel>
        </Grid>

        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsManageMode, Mode=OneTime}" Value="False">
                <Setter TargetName="lst" Property="bhv:DoubleClickBehavior.Command" Value="{Binding AcceptCommand}"/>
                <Setter TargetName="filter" Property="bhv:FocusOnLoadBehavior.IsAttached" Value="True"/>
            </DataTrigger>
            <!--<DataTrigger Binding="{Binding IsManageMode, Mode=OneTime}" Value="True">
                <Setter TargetName="lst" Property="ItemContainerStyle" Value="{StaticResource NoSelectionItemContainerStyle}"/>
            </DataTrigger>-->
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="EquipmentExplorerView">
        <DockPanel LastChildFill="True" Margin="2">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" HorizontalAlignment="Stretch" Margin="2">
                <TextBlock Text="Filter: " VerticalAlignment="Center"/>
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" Margin="2" Padding="2" VerticalAlignment="Center" MinWidth="160" MaxWidth="350" bhv:FocusOnLoadBehavior.IsAttached="True"/>
            </StackPanel>

            <ItemsControl ItemsSource="{Binding Equipments, Mode=OneTime}" ItemTemplate="{StaticResource ArmorPieceView}" VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.ScrollUnit="Pixel" ScrollViewer.CanContentScroll="True" Focusable="False">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <VirtualizingStackPanel />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.Template>
                    <ControlTemplate>
                        <Border
                            BorderThickness="{TemplateBinding Border.BorderThickness}"
                            Padding="{TemplateBinding Control.Padding}"
                            BorderBrush="{TemplateBinding Border.BorderBrush}"
                            Background="{TemplateBinding Panel.Background}"
                            SnapsToDevicePixels="True">
                            <ScrollViewer Padding="{TemplateBinding Control.Padding}" Focusable="False">
                                <ItemsPresenter SnapsToDevicePixels="{TemplateBinding UIElement.SnapsToDevicePixels}" />
                            </ScrollViewer>
                        </Border>
                    </ControlTemplate>
                </ItemsControl.Template>
            </ItemsControl>

        </DockPanel>
    </DataTemplate>

    <DataTemplate x:Key="SearchResultProcessingContainerMasterView">
        <Grid HorizontalAlignment="Stretch">
            <Grid x:Name="readonly">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock x:Name="readonlyName" Grid.Column="0" Text="{Binding Name}" VerticalAlignment="Center"/>
                <TextBlock x:Name="readonlyCount" Grid.Column="1" Text="{Binding SortItems.Count, StringFormat=({0})}" Margin="4" VerticalAlignment="Center"/>
                <Button Grid.Column="2" Content="Apply" Command="{Binding ApplyCommand, Mode=OneTime}" Margin="1" Padding="8 4 8 4" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" bhv:ToolTipEx.Content="Applies the sorting logic right now"/>
                <Button x:Name="deactiveBtn" Grid.Column="3" Content="Deactivate" Command="{Binding DeactivateCommand, Mode=OneTime}" Margin="1" Padding="8 4 8 4" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" bhv:ToolTipEx.Content="Deactivates the sorting logic (default sorting will apply)" Visibility="Hidden"/>
                <Button x:Name="activeBtn" Grid.Column="3" Content="Make active" Command="{Binding MakeActiveCommand, Mode=OneTime}" Margin="1" Padding="8 4 8 4" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" bhv:ToolTipEx.Content="Applies the sorting logic right now and make it the default for subsequent searches"/>
            </Grid>
            <DockPanel x:Name="edit" LastChildFill="True" Visibility="Hidden" VerticalAlignment="Center" Margin="24 0 0 0">
                <Button DockPanel.Dock="Right" Content="X" bhv:ToolTipEx.Content="Remove" Width="{Binding ActualHeight, RelativeSource={RelativeSource Mode=Self}}" Command="{Binding RemoveSelfCommand, Mode=OneTime}" Margin="1"/>
                <UniformGrid Rows="2" DockPanel.Dock="Right" Width="{Binding ActualHeight, RelativeSource={RelativeSource Mode=Self}}">
                    <Button Command="{Binding MoveSelfUpCommand, Mode=OneTime}" bhv:ToolTipEx.Content="Move up" Margin="1"/>
                    <Button Command="{Binding MoveSelfDownCommand, Mode=OneTime}" bhv:ToolTipEx.Content="Move down" Margin="1"/>
                </UniformGrid>
                <TextBox Text="{Binding Name}" HorizontalAlignment="Stretch" Margin="1" Padding="2"/>
            </DockPanel>
        </Grid>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsActive}" Value="True">
                <Setter TargetName="readonly" Property="TextBlock.Foreground" Value="Blue"/>
                <Setter TargetName="readonlyName" Property="FontWeight" Value="Bold"/>
                <Setter TargetName="readonlyCount" Property="FontWeight" Value="Bold"/>
                <Setter TargetName="deactiveBtn" Property="Foreground" Value="Blue"/>
                <Setter TargetName="deactiveBtn" Property="Visibility" Value="Visible"/>
                <Setter TargetName="activeBtn" Property="Visibility" Value="Hidden"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                <Setter TargetName="readonly" Property="Visibility" Value="Hidden"/>
                <Setter TargetName="edit" Property="Visibility" Value="Visible"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="SearchResultSortItemView">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" SharedSizeGroup="A"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="{Binding HeaderText}" VerticalAlignment="Center" Margin="1"/>
            <ComboBox Grid.Column="1" SelectedItem="{Binding SortCriteria}" ItemsSource="{x:Static local:SearchResultSortCriteriaDataSource.Instance}" VerticalAlignment="Center" Margin="1">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Converter={StaticResource SortCriteriaNameValueConverter}}" Margin="2"/>
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Stretch" Margin="0">
                <UniformGrid Rows="2" Width="{Binding ActualHeight, RelativeSource={RelativeSource Mode=Self}}" Margin="0">
                    <Button Command="{Binding MoveSelfUpCommand, Mode=OneTime}" bhv:ToolTipEx.Content="Move up" Margin="1"/>
                    <Button Command="{Binding MoveSelfDownCommand, Mode=OneTime}" bhv:ToolTipEx.Content="Move down" Margin="1"/>
                </UniformGrid>
                <Button Content="X" bhv:ToolTipEx.Content="Remove" Width="{Binding ActualHeight, RelativeSource={RelativeSource Mode=Self}}" Command="{Binding RemoveSelfCommand, Mode=OneTime}" Margin="1"/>
            </StackPanel>
        </Grid>
    </DataTemplate>

    <DataTemplate x:Key="SearchResultProcessingContainerDetailView">
        <DockPanel LastChildFill="True">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Top">
                <Button Content="Add sort criteria" Command="{Binding AddSortItemCommand}" Margin="2" Padding="8 4 8 4"/>
            </StackPanel>
            <ItemsControl Margin="2" ItemsSource="{Binding SortItems}" ItemTemplate="{StaticResource SearchResultSortItemView}" Grid.IsSharedSizeScope="True"/>
        </DockPanel>
    </DataTemplate>

    <DataTemplate x:Key="SearchResultProcessingView">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="6"/>
                <ColumnDefinition Width="1.5*"/>
            </Grid.ColumnDefinitions>
            <DockPanel Grid.Column="0" LastChildFill="True">
                <DockPanel DockPanel.Dock="Top">
                    <Button Content="?" DockPanel.Dock="Left" MinWidth="20" Margin="2" Padding="4" VerticalAlignment="Center" Command="{Binding OpenIntegratedHelpCommand, Mode=OneTime}" CommandParameter="Sorting" IsEnabled="True" bhv:ToolTipEx.Content="Show help about sorting"/>
                    <Button Content="Add sorting logic" DockPanel.Dock="Left" HorizontalAlignment="Left" Command="{Binding CreateNewCommand, Mode=OneTime}" Margin="2" Padding="8 4 8 4"/>
                    <ToggleButton x:Name="edit" Content="Edit mode" DockPanel.Dock="Right" HorizontalAlignment="Right" IsChecked="{Binding IsEditMode, Mode=TwoWay}" Visibility="{Binding HasContainers, Converter={StaticResource CollapsedVisibilityValueConverter}}" Margin="2" Padding="4"/>
                </DockPanel>
                <ListBox ItemsSource="{Binding Containers, Mode=OneWay}" ItemTemplate="{StaticResource SearchResultProcessingContainerMasterView}" HorizontalContentAlignment="Stretch" SelectedItem="{Binding SelectedContainer}" Margin="2"/>
            </DockPanel>
            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch"/>
            <ContentControl Grid.Column="2" Content="{Binding SelectedContainer}" ContentTemplate="{StaticResource SearchResultProcessingContainerDetailView}" Visibility="{Binding HasSelection, Converter={StaticResource CollapsedVisibilityValueConverter}}"/>
        </Grid>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsEditMode, Mode=TwoWay}" Value="True">
                <Setter TargetName="edit" Property="Foreground" Value="Blue"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <DataTemplate x:Key="SharpnessView">
        <StackPanel Orientation="Horizontal">
            <Rectangle Fill="#FF67FF6E" Height="Auto" Width="{Binding Red, Mode=OneTime}"/>
        </StackPanel>
    </DataTemplate>

    <DataTemplate x:Key="WeaponElementView">
        <StackPanel x:Name="root" Orientation="Horizontal">
            <Image Source="{Binding Type, Mode=OneTime, Converter={StaticResource ElementEnumToImageSourceValueConverter}, ConverterParameter=16}" Width="16" Height="16" Margin="2" VerticalAlignment="Center" bhv:ToolTipEx.Content="{Binding Type, Mode=OneTime, Converter={StaticResource ElementNameValueConverter}}"/>
            <TextBlock Text="(" Visibility="{Binding IsHidden, Converter={StaticResource CollapsedVisibilityValueConverter}}" VerticalAlignment="Center"/>
            <TextBlock Text="{Binding Value}" VerticalAlignment="Center"/>
            <TextBlock Text=")" Visibility="{Binding IsHidden, Converter={StaticResource CollapsedVisibilityValueConverter}}" VerticalAlignment="Center"/>
        </StackPanel>
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsHidden}" Value="True">
                <Setter TargetName="root" Property="Opacity" Value="0.4"/>
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <HierarchicalDataTemplate x:Key="WeaponView" ItemsSource="{Binding Branches}">
        <Grid Width="185" Height="96" Margin="12" TextBlock.FontWeight="Bold">
            <Border x:Name="filteredText" BorderBrush="#FF0080FF" BorderThickness="6" Margin="-5" CornerRadius="4" Visibility="Hidden" IsHitTestVisible="False"/>
            <Border x:Name="root" BorderBrush="Gray" Background="LightGray" BorderThickness="1" CornerRadius="3">
                <StackPanel HorizontalAlignment="Stretch" VerticalAlignment="Stretch"> <!-- Splits name at top and the rest at bottom -->
                    <Viewbox VerticalAlignment="Top" HorizontalAlignment="Left" StretchDirection="DownOnly">
                        <TextBlock Text="{mxt:Localization Name}" FontWeight="Bold" Margin="5" VerticalAlignment="Center"/>
                    </Viewbox>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Stretch"> <!-- Splits attributes on the right and the rest on the left -->
                        <DockPanel VerticalAlignment="Stretch"> <!-- Splits slots at bottom and the rest at top -->
                            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="3 1 3 1">
                                <Border VerticalAlignment="Top" BorderBrush="#FFA0A0A0" BorderThickness="2" CornerRadius="2" Background="#FFC0C0C0">
                                    <Image Source="{Binding Type, Mode=OneTime, Converter={StaticResource WeaponEnumToImageSourceValueConverter}, ConverterParameter=24}" Width="24" Height="24" Margin="2"/>
                                </Border>
                                <StackPanel VerticalAlignment="Top">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Top">
                                        <Image Source="{mxt:RasterizedImage Location=Icons/Attributes/Attack.svg, Size=16}" Width="16" Height="16" VerticalAlignment="Center" Margin="2" SnapsToDevicePixels="True"/>
                                        <TextBlock Text="{Binding Attack, Mode=OneTime}" Margin="2"/>
                                    </StackPanel>
                                    <Border BorderThickness="1" BorderBrush="Black" CornerRadius="0" Margin="3" Visibility="{Binding HasSharpness, Mode=OneTime, Converter={StaticResource CollapsedVisibilityValueConverter}}">
                                        <ctrl:SharpnessRenderer Width="80" Height="10" FullSharpnessHeight="3" Background="#FF1E1E1E" SharpnessLevels="{Binding SharpnessLevels, Mode=OneTime}" SharpnessRank="{Binding Parent.SharpnessRank}"/>
                                    </Border>
                                    <StackPanel Orientation="Horizontal" Visibility="{Binding HasDeviation, Mode=OneTime, Converter={StaticResource CollapsedVisibilityValueConverter}}">
                                        <Image Source="{mxt:RasterizedImage Location=Icons/Attributes/Deviation.svg, Size=14}" Width="14" Height="14" VerticalAlignment="Center" Margin="2" SnapsToDevicePixels="True" bhv:ToolTipEx.Content="Deviation"/>
                                        <TextBlock Text="{Binding Attributes.Deviation, Mode=OneTime}" Margin="2"/>
                                    </StackPanel>
                                </StackPanel>
                            </StackPanel>
                            <ItemsControl DockPanel.Dock="Bottom" ItemsSource="{Binding Slots}" ItemTemplate="{StaticResource SlotImageView}" Margin="2" Focusable="False">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </DockPanel>
                        <StackPanel> <!-- Splits element, affinity and defense -->
                            <ItemsControl ItemsSource="{Binding Elements, Mode=OneTime}" ItemTemplate="{StaticResource WeaponElementView}" Margin="2"/>
                            <StackPanel Orientation="Horizontal" Visibility="{Binding HasAffinity, Mode=OneTime, Converter={StaticResource CollapsedVisibilityValueConverter}}">
                                <Image Source="{mxt:RasterizedImage Location=Icons/Attributes/Affinity.svg, Size=16}" Width="16" Height="16" VerticalAlignment="Center" Margin="2" SnapsToDevicePixels="True" bhv:ToolTipEx.Content="Affinity"/>
                                <TextBlock Text="{Binding Attributes.Affinity, Mode=OneTime, StringFormat=\{0\}%}" Margin="2"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Visibility="{Binding HasDefense, Mode=OneTime, Converter={StaticResource CollapsedVisibilityValueConverter}}">
                                <Image Source="{mxt:RasterizedImage Location=Icons/Attributes/Defense.svg, Size=16}" Width="16" Height="16" VerticalAlignment="Center" Margin="2" SnapsToDevicePixels="True" bhv:ToolTipEx.Content="Defense"/>
                                <TextBlock Text="{Binding Attributes.Defense, Mode=OneTime}" Margin="2"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </Border>
            <Border x:Name="fg" Background="#80FFFFFF" CornerRadius="3" IsHitTestVisible="False" Visibility="Hidden"/>
            <Grid Visibility="{Binding IsPossessed, Converter={StaticResource HiddenVisibilityValueConverter}}" HorizontalAlignment="Right" VerticalAlignment="Top" IsHitTestVisible="False" SnapsToDevicePixels="True" Margin="3">
                <Image Source="{mxt:RasterizedImage Location=Icons/Others/cube_chest.svg, Size=16}" Width="16" Height="16"/>
                <TextBlock Text="{Binding PossessedCount}" FontSize="1" Foreground="White" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center" Visibility="{Binding IsPossessedMoreThanOnce, Converter={StaticResource HiddenVisibilityValueConverter}}" RenderTransformOrigin="0.5, 0.5">
                    <TextBlock.RenderTransform>
                        <ScaleTransform ScaleX="12" ScaleY="12"/>
                    </TextBlock.RenderTransform>
                </TextBlock>
            </Grid>
        </Grid>
        <HierarchicalDataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsHighlight}" Value="True">
                <Setter TargetName="root" Property="Background" Value="{StaticResource ActiveWeaponBackgroundBrush}"/>
                <Setter TargetName="root" Property="BorderBrush" Value="{StaticResource ActiveWeaponBorderBrush}"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding IsHighlight}" Value="False">
                <Setter TargetName="fg" Property="Visibility" Value="Visible"/>
            </DataTrigger>
            <DataTrigger Binding="{Binding IsFilteredText}" Value="True">
                <Setter TargetName="filteredText" Property="Visibility" Value="Visible"/>
            </DataTrigger>
        </HierarchicalDataTemplate.Triggers>
    </HierarchicalDataTemplate>

    <DataTemplate x:Key="WeaponTypeView">
        <DockPanel LastChildFill="True" Visibility="{Binding IsActive, Converter={StaticResource CollapsedVisibilityValueConverter}}">
            <Border DockPanel.Dock="Top" BorderThickness="0,0,0,1" BorderBrush="LightGray">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" Background="#FFE8E8E8">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0 0 32 0">
                        <StackPanel VerticalAlignment="Center" Margin="0 0 32 0">
                            <TextBlock Text="Search: " Margin="2" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" Width="200" Margin="2,2,2,4" Padding="3" VerticalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel VerticalAlignment="Center" Margin="0 0 32 0" Visibility="{Binding IsSharpnessWeapon, Mode=OneTime, Converter={StaticResource CollapsedVisibilityValueConverter}}">
                            <TextBlock Text="Sharpness rank: " Margin="2"/>
                            <StackPanel Orientation="Horizontal">
                                <Slider Minimum="0" Maximum="5" Value="{Binding SharpnessRank}" Width="120" TickPlacement="BottomRight" VerticalAlignment="Center" Margin="2"/>
                                <TextBlock Text="{Binding SharpnessRank, Converter={StaticResource SharpnessNameValueConverter}}" VerticalAlignment="Top" Margin="2" bhv:MinWidthBehavior.IsAttached="True"/>
                            </StackPanel>
                        </StackPanel>
                        <StackPanel VerticalAlignment="Center" Margin="0 0 32 0" Visibility="{Binding IsSharpnessWeapon, Mode=OneTime, Converter={StaticResource CollapsedVisibilityValueConverter}}">
                            <TextBlock Text="Free element: " Margin="2"/>
                            <StackPanel Orientation="Horizontal">
                                <Slider Minimum="0" Maximum="3" Value="{Binding FreeElementLevel}" Width="120" TickPlacement="BottomRight" VerticalAlignment="Center" Margin="2"/>
                                <TextBlock Text="{Binding FreeElementLevel, Converter={StaticResource FreeElementNameValueConverter}}" VerticalAlignment="Top" Margin="2" bhv:MinWidthBehavior.IsAttached="True"/>
                            </StackPanel>
                        </StackPanel>
                        <StackPanel VerticalAlignment="Center" Margin="0 0 32 0">
                            <TextBlock Text="Slot augmentation: " Margin="2"/>
                            <StackPanel Orientation="Horizontal">
                                <Slider Minimum="0" Maximum="3" Value="{Binding SlotAugmentationCount}" Width="120" TickPlacement="BottomRight" VerticalAlignment="Center" Margin="2"/>
                                <TextBlock Text="{Binding SlotAugmentationCount, StringFormat=+\{0\}}" VerticalAlignment="Top" Margin="2" bhv:MinWidthBehavior.IsAttached="True"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
            <Grid>
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Visibility="{Binding IsDataLoading, Converter={StaticResource CollapsedVisibilityValueConverter}, Mode=OneWay}">
                    <TextBlock Text="Constructing user interface..." FontSize="20" HorizontalAlignment="Center" Margin="2"/>
                    <TextBlock Text="(only the first time per weapon)" FontSize="14" HorizontalAlignment="Center" Margin="2"/>
                </StackPanel>
                <ctrl:DraggableScrollViewer HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Visible" bhv:HorizontalScrollBehavior.IsAttached="True">
                    <ctrl:CustomTreeView LineBrush="#FFC0C0C0" LineThickness="3" Margin="16"
                                         ItemsSource="{Binding RootWeapons}" ItemTemplate="{StaticResource WeaponView}"
                                         ScrollViewer.HorizontalScrollBarVisibility="Disabled" ScrollViewer.VerticalScrollBarVisibility="Disabled" ScrollViewer.CanContentScroll="False"/>
                </ctrl:DraggableScrollViewer>
            </Grid>
        </DockPanel>
    </DataTemplate>

    <DataTemplate x:Key="WeaponsContainerView">
        <DockPanel LastChildFill="True" Visibility="{Binding IsDataLoaded, Converter={StaticResource HiddenVisibilityValueConverter}}">
            <Grid DockPanel.Dock="Top" Background="#FFE8E8E8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <ScrollViewer Grid.Column="0" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding WeaponTypes}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button x:Name="toggle" Command="{Binding ActivateCommand, Mode=OneTime}" Margin="2" Padding="4" VerticalContentAlignment="Center" HorizontalAlignment="Center" ToolTip="{Binding Type, Mode=OneTime, Converter={StaticResource WeaponNameValueConverter}}">
                                    <Button.Content>
                                        <Image Source="{Binding Type, Mode=OneTime, Converter={StaticResource WeaponEnumToImageSourceValueConverter}, ConverterParameter=32}" Width="32" Height="32"/>
                                    </Button.Content>
                                </Button>
                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding IsActive}" Value="True">
                                        <Setter TargetName="toggle" Property="Background" Value="{StaticResource ActiveWeaponBackgroundBrush}"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </ScrollViewer>
                <Button Grid.Column="1" Margin="2" Padding="8" VerticalAlignment="Top" Content="Import from save..." Command="{Binding ImportCommand, Mode=OneTime}"/>
            </Grid>
            <ItemsControl ItemsSource="{Binding WeaponTypes}" ItemTemplate="{StaticResource WeaponTypeView}" Background="#06000000">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Grid/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>
        </DockPanel>
    </DataTemplate>

</ResourceDictionary>
